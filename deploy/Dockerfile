# overwatch-identity/deploy/Dockerfile
#
# Auto-generated by generate-dockerfile.sh
# Regenerate: ./overwatch-infra/scripts/generate-dockerfile.sh identity
#
# Build:
#   1. Build base (once):  cd overwatch-infra && docker build -t overwatch-base:latest --target builder -f docker/base/Dockerfile.base docker/base/ && docker build -t overwatch-base:runtime --target runtime -f docker/base/Dockerfile.base docker/base/
#   2. Build service:      cd overwatch-identity && docker build -f deploy/Dockerfile -t overwatch-identity:latest .
#

# =============================================================================
# Stage 1: Build
# =============================================================================
FROM overwatch-base:latest AS builder

ARG VERSION=dev
ARG COMMIT=unknown
ARG BUILD_TIME=unknown

COPY go.mod go.sum ./
RUN go mod download

COPY . .

RUN go build \
    -ldflags="-w -s \
        -X main.Version=${VERSION} \
        -X main.Commit=${COMMIT} \
        -X main.BuildTime=${BUILD_TIME}" \
    -o /build/server \
    ./cmd/server

# =============================================================================
# Stage 2: Runtime
# =============================================================================
FROM overwatch-base:runtime AS runtime

COPY --from=builder /build/server /app/server
COPY --from=builder /build/migrations /app/migrations/

EXPOSE 9090 8081

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:8081/health/live || exit 1

ENTRYPOINT ["/app/server"]
